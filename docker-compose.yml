# =============================================================================
# OASIS Docker Compose - Configuraci√≥n Limpia Integrada
# Versi√≥n unificada que integra todos los scripts nativos
# =============================================================================

services:
  oasis-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: oasis-server-dev
    ports:
      - "8008:8008"   # Puerto SSB
      - "3000:3000"   # Puerto cliente web
    volumes:
      # Volumenes persistentes para datos cr√≠ticos
      - oasis-ssb-data-dev:/home/oasis/.ssb
      - oasis-ai-models-dev:/app/src/AI/models
      - oasis-logs-dev:/app/logs   

    environment:
      - NODE_ENV=production
      # üîß DEFINITIVO: Prohibir compilaci√≥n completamente
      - NODE_LLAMA_CPP_SKIP_DOWNLOAD=false
      - NODE_LLAMA_CPP_USE_PREBUILT_BINARIES=true
      - NODE_LLAMA_CPP_BUILD_FROM_SOURCE=false
      - NODE_LLAMA_CPP_FORCE_BUILD=never
      - NODE_LLAMA_CPP_SKIP_LLAMA_CPP_CLONE=true
      # GPU Configuration 
      - GPU_ENABLED=true
      - GPU_LAYERS=35
      - VRAM_PADDING=256
      # NVIDIA GPU Configuration
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    
    # ‚úÖ GPU habilitada con runtime nvidia y configuraci√≥n dual
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# Volumenes persistentes nombrados
volumes:
  oasis-ssb-data-dev:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes-dev/ssb-data
  
  oasis-ai-models-dev:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes-dev/ai-models
  
  oasis-logs-dev:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./volumes-dev/logs

# Red personalizada (opcional para futura expansi√≥n)
networks:
  default:
    name: oasis-network-dev